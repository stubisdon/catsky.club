<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catsky Club</title>
    <!-- Workaround for Portal bug with undefined firstpromoter_account - MUST load before Portal -->
    <script>
      // Comprehensive patch for Portal bug - patches fetch, XMLHttpRequest, and Response.json()
      // This must run immediately, before Portal script loads
      (function() {
        'use strict';
        
        // Helper to fix firstpromoter_account in data
        function fixFirstPromoter(data) {
          if (data && data.settings) {
            if (data.settings.firstpromoter_account === undefined || data.settings.firstpromoter_account === null) {
              data.settings.firstpromoter_account = '';
            }
          }
          return data;
        }
        
        // Patch Response.prototype.json
        const originalJson = Response.prototype.json;
        Response.prototype.json = function() {
          const url = this.url || '';
          if (url.includes('/ghost/api/content/settings/')) {
            return originalJson.call(this).then(data => fixFirstPromoter(data));
          }
          return originalJson.call(this);
        };
        
        // Patch fetch
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0];
          const isSettingsApi = typeof url === 'string' && url.includes('/ghost/api/content/settings/');
          
          if (isSettingsApi) {
            return originalFetch.apply(this, args).then(async response => {
              if (!response.ok) return response;
              
              try {
                const text = await response.clone().text();
                const data = JSON.parse(text);
                const fixedData = fixFirstPromoter(data);
                
                const fixedResponse = new Response(JSON.stringify(fixedData), {
                  status: response.status,
                  statusText: response.statusText,
                  headers: {
                    ...Object.fromEntries(response.headers.entries()),
                    'Content-Type': 'application/json'
                  }
                });
                
                Object.defineProperty(fixedResponse, 'url', {
                  value: response.url,
                  writable: false,
                  configurable: true
                });
                
                return fixedResponse;
              } catch (e) {
                console.warn('[Portal workaround] Failed to patch response:', e);
                return response;
              }
            });
          }
          
          return originalFetch.apply(this, args);
        };
        
        // Patch XMLHttpRequest (in case Portal uses it)
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;
        const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
        
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
          this._portalWorkaroundUrl = url;
          return originalXHROpen.call(this, method, url, ...rest);
        };
        
        XMLHttpRequest.prototype.send = function(...args) {
          const xhr = this;
          const url = xhr._portalWorkaroundUrl || '';
          
          if (url.includes('/ghost/api/content/settings/')) {
            const originalOnReadyStateChange = xhr.onreadystatechange;
            xhr.onreadystatechange = function() {
              if (xhr.readyState === 4 && xhr.status === 200) {
                try {
                  const data = JSON.parse(xhr.responseText);
                  const fixedData = fixFirstPromoter(data);
                  Object.defineProperty(xhr, 'responseText', {
                    value: JSON.stringify(fixedData),
                    writable: false,
                    configurable: true
                  });
                } catch (e) {
                  // Ignore parse errors
                }
              }
              if (originalOnReadyStateChange) {
                originalOnReadyStateChange.apply(this, arguments);
              }
            };
          }
          
          return originalXHRSend.apply(this, args);
        };
      })();
    </script>
    <!-- Ghost Portal (Members + Paid subscriptions) -->
    <!-- Required env vars (Vite): VITE_GHOST_URL, VITE_GHOST_CONTENT_API_KEY -->
    <!-- Portal loads from CDN in Ghost 6.0+ -->
    <script
      src="https://cdn.jsdelivr.net/ghost/portal@latest/umd/portal.min.js"
      data-ghost="%VITE_GHOST_URL%"
      data-key="%VITE_GHOST_CONTENT_API_KEY%"
      defer
    ></script>
  </head>
  <body>
    <!-- Portal binds click handlers at load time to existing DOM nodes.
         We keep these triggers outside React and move them into pages as needed. -->
    <div id="ghost-portal-trigger-stash" style="display:none">
      <button id="ghost-portal-trigger-signup" data-portal="signup" type="button"></button>
      <button id="ghost-portal-trigger-signin" data-portal="signin" type="button"></button>
      <button id="ghost-portal-trigger-account" data-portal="account" type="button"></button>
    </div>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

